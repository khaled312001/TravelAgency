import{d as t,a as s,c as e,g as o}from"../../../_/nitro.mjs";import{createClient as a}from"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"vue";import"@iconify/utils";import"node:crypto";import"consola";import"node:module";import"node:url";import"ipx";import"node:fs";import"node:path";const i=t((async t=>{try{await async function(t){const s=o(t,"authorization");if(!s||!s.startsWith("Bearer "))throw e({statusCode:401,statusMessage:"No valid session token provided"});const i=s.substring(7),r="https://ueofktshvaqtxjsxvisv.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlb2ZrdHNodmFxdHhqc3h2aXN2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTkyMzE3NiwiZXhwIjoyMDc1NDk5MTc2fQ.8x1bRWz6UgyRgkMQf5c32qABhgRNnY-p8Q2Sz9S-jn0",c=a(r,n),{data:p,error:d}=await c.from("admin_sessions").select("expires_at").eq("session_token",i).single();if(d||!p)throw e({statusCode:401,statusMessage:"Invalid session"});const I=new Date,h=new Date(p.expires_at);if(I>h)throw e({statusCode:401,statusMessage:"Session expired"})}(t);const i=s(t),r=a("https://ueofktshvaqtxjsxvisv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlb2ZrdHNodmFxdHhqc3h2aXN2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTkyMzE3NiwiZXhwIjoyMDc1NDk5MTc2fQ.8x1bRWz6UgyRgkMQf5c32qABhgRNnY-p8Q2Sz9S-jn0"),n=parseInt(i.page)||1,c=parseInt(i.limit)||10,p=i.search,d=i.destination,I=i.sortBy||"created_at",h=i.sortOrder||"desc";let m=r.from("packages").select("*",{count:"exact"});p&&(m=m.or(`title.ilike.%${p}%,description.ilike.%${p}%`)),d&&(m=m.eq("destination",d)),m=m.order(I,{ascending:"asc"===h});const l=(n-1)*c,u=l+c-1;m=m.range(l,u);const{data:f,error:g,count:M}=await m;if(g)throw e({statusCode:500,statusMessage:"Failed to fetch packages"});const k=Math.ceil((M||0)/c);return{data:f||[],pagination:{page:n,limit:c,total:M||0,totalPages:k,hasNext:n<k,hasPrev:n>1}}}catch(t){if(console.error("Packages fetch error:",t),t.statusCode)throw t;throw e({statusCode:500,statusMessage:"Internal server error"})}}));export{i as default};
//# sourceMappingURL=index.get.mjs.map
