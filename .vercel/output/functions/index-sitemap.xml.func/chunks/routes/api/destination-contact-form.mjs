import{d as i,r as e,b as t}from"../../_/nitro.mjs";import o from"twilio";import{s as n}from"../../_/serverSupabaseServiceRole.mjs";import{s as r}from"../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"vue";import"@iconify/utils";import"node:crypto";import"consola";import"node:module";import"node:url";import"ipx";import"node:fs";import"node:path";import"@supabase/supabase-js";import"@supabase/ssr";const a=i((async i=>{const a=await e(i),s=a.locale||"en-US";let c;try{c=await n(i)}catch(e){console.warn("Failed to use Supabase service role client, falling back to regular client:",e),c=await r(i)}try{const{data:i,error:e}=await c.from("destination_inquiries").insert({name:a.name,email:a.email,phone:a.phone,destination_name:a.destinationName,message:a.message,created_at:(new Date).toISOString(),locale:s,notification_sent:!1}).select();if(e)return console.error("Failed to save destination inquiry to Supabase:",e),{success:!1,error:`Database error: ${e.message}`,notificationSent:!1};if(!i||0===i.length)return console.error("No data returned from Supabase insert"),{success:!1,error:"Failed to save destination inquiry",notificationSent:!1};try{const e=t();if(!(e.twilioAccountSid&&e.twilioAuthToken&&e.twilioPhoneNumber&&e.salesManagerPhone))return console.error("Missing Twilio configuration for destination inquiry:",{twilioAccountSid:e.twilioAccountSid?"present":"missing",twilioAuthToken:e.twilioAuthToken?"present":"missing",twilioPhoneNumber:e.twilioPhoneNumber?"present":"missing",salesManagerPhone:e.salesManagerPhone?"present":"missing"}),await c.from("destination_inquiries").update({notification_sent:!1,notification_error:"Incomplete Twilio configuration"}).eq("id",i[0].id),{success:!0,inquiryId:i[0].id,notificationSent:!1,error:"Incomplete Twilio configuration"};try{const t=o(e.twilioAccountSid,e.twilioAuthToken),n=s.startsWith("ar")?`طلب استفسار عن وجهة سياحية جديد!\n          \n    العميل: ${a.name}\n    البريد الإلكتروني: ${a.email}\n    الهاتف: ${a.phone}\n    الوجهة: ${a.destinationName}\n    الرسالة: ${a.message}`:`New Destination Inquiry!\n          \n    Customer: ${a.name}\n    Email: ${a.email}\n    Phone: ${a.phone}\n    Destination: ${a.destinationName}\n    Message: ${a.message}`,r=await t.messages.create({from:`whatsapp:${e.twilioPhoneNumber}`,to:`whatsapp:${e.salesManagerPhone}`,body:n});return await c.from("destination_inquiries").update({notification_sent:!0,notification_id:r.sid}).eq("id",i[0].id),{success:!0,inquiryId:i[0].id,notificationSent:!0,notificationId:r.sid}}catch(e){return console.error("Twilio client error for destination inquiry:",e),await c.from("destination_inquiries").update({notification_sent:!1,notification_error:e.message||"Twilio error"}).eq("id",i[0].id),{success:!0,inquiryId:i[0].id,notificationSent:!1,error:e.message||"Failed to send WhatsApp notification"}}}catch(e){return console.error("WhatsApp notification for destination inquiry failed:",e),await c.from("destination_inquiries").update({notification_sent:!1,notification_error:e.message||"Unknown error"}).eq("id",i[0].id),{success:!0,inquiryId:i[0].id,notificationSent:!1,error:e.message||"Failed to send WhatsApp notification"}}}catch(i){return console.error("Destination contact form submission failed:",i),{success:!1,error:i.message||"Failed to process destination contact form",notificationSent:!1}}}));export{a as default};
//# sourceMappingURL=destination-contact-form.mjs.map
