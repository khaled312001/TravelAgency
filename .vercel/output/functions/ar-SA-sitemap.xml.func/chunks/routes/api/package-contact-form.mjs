import{d as e,r as i,b as o}from"../../_/nitro.mjs";import t from"twilio";import{s as n}from"../../_/serverSupabaseServiceRole.mjs";import{s as a}from"../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"vue";import"@iconify/utils";import"node:crypto";import"consola";import"node:module";import"node:url";import"ipx";import"node:fs";import"node:path";import"@supabase/supabase-js";import"@supabase/ssr";const r=e((async e=>{const r=await i(e),s=r.locale||"en-US";let c;try{c=await n(e)}catch(i){console.warn("Failed to use Supabase service role client, falling back to regular client:",i),c=await a(e)}try{const{data:e,error:i}=await c.from("package_inquiries").insert({name:r.name,email:r.email,phone:r.phone,package_id:r.packageId,package_name:r.packageName,message:r.message,created_at:(new Date).toISOString(),locale:s,notification_sent:!1}).select();if(i)return console.error("Failed to save inquiry to Supabase:",i),{success:!1,error:`Database error: ${i.message}`,notificationSent:!1};if(!e||0===e.length)return console.error("No data returned from Supabase insert"),{success:!1,error:"Failed to save inquiry",notificationSent:!1};try{const i=o();if(!(i.twilioAccountSid&&i.twilioAuthToken&&i.twilioPhoneNumber&&i.salesManagerPhone))return console.error("Missing Twilio configuration:",{twilioAccountSid:i.twilioAccountSid?"present":"missing",twilioAuthToken:i.twilioAuthToken?"present":"missing",twilioPhoneNumber:i.twilioPhoneNumber?"present":"missing",salesManagerPhone:i.salesManagerPhone?"present":"missing"}),await c.from("package_inquiries").update({notification_sent:!1,notification_error:"Incomplete Twilio configuration"}).eq("id",e[0].id),{success:!0,inquiryId:e[0].id,notificationSent:!1,error:"Incomplete Twilio configuration"};try{const o=t(i.twilioAccountSid,i.twilioAuthToken),n=s.startsWith("ar")?`طلب حجز جديد!\n          \n    العميل: ${r.name}\n    البريد الإلكتروني: ${r.email}\n    الهاتف: ${r.phone}\n    الباقة: ${r.packageName}\n    الرسالة: ${r.message}`:`New Package Inquiry!\n          \n    Customer: ${r.name}\n    Email: ${r.email}\n    Phone: ${r.phone}\n    Package: ${r.packageName}\n    Message: ${r.message}`,a=await o.messages.create({from:`whatsapp:${i.twilioPhoneNumber}`,to:`whatsapp:${i.salesManagerPhone}`,body:n});return await c.from("package_inquiries").update({notification_sent:!0,notification_id:a.sid}).eq("id",e[0].id),{success:!0,inquiryId:e[0].id,notificationSent:!0,notificationId:a.sid}}catch(i){return console.error("Twilio client error:",i),await c.from("package_inquiries").update({notification_sent:!1,notification_error:i.message||"Twilio error"}).eq("id",e[0].id),{success:!0,inquiryId:e[0].id,notificationSent:!1,error:i.message||"Failed to send WhatsApp notification"}}}catch(i){return console.error("WhatsApp notification failed:",i),await c.from("package_inquiries").update({notification_sent:!1,notification_error:i.message||"Unknown error"}).eq("id",e[0].id),{success:!0,inquiryId:e[0].id,notificationSent:!1,error:i.message||"Failed to send WhatsApp notification"}}}catch(e){return console.error("Contact form submission failed:",e),{success:!1,error:e.message||"Failed to process contact form",notificationSent:!1}}}));export{r as default};
//# sourceMappingURL=package-contact-form.mjs.map
