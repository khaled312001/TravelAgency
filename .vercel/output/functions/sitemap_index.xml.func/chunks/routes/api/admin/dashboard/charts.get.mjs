import{d as t,c as e,g as o}from"../../../../_/nitro.mjs";import{createClient as s}from"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"vue";import"@iconify/utils";import"node:crypto";import"consola";import"node:module";import"node:url";import"ipx";import"node:fs";import"node:path";const n=t((async t=>{try{await async function(t){const n=o(t,"authorization");if(!n||!n.startsWith("Bearer "))throw e({statusCode:401,statusMessage:"No valid session token provided"});const a=n.substring(7),i="https://ueofktshvaqtxjsxvisv.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlb2ZrdHNodmFxdHhqc3h2aXN2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTkyMzE3NiwiZXhwIjoyMDc1NDk5MTc2fQ.8x1bRWz6UgyRgkMQf5c32qABhgRNnY-p8Q2Sz9S-jn0",c=s(i,r),{data:u,error:d}=await c.from("admin_sessions").select("expires_at").eq("session_token",a).single();if(d||!u)throw e({statusCode:401,statusMessage:"Invalid session"});const p=new Date,l=new Date(u.expires_at);if(p>l)throw e({statusCode:401,statusMessage:"Session expired"})}(t);const n=s("https://ueofktshvaqtxjsxvisv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlb2ZrdHNodmFxdHhqc3h2aXN2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTkyMzE3NiwiZXhwIjoyMDc1NDk5MTc2fQ.8x1bRWz6UgyRgkMQf5c32qABhgRNnY-p8Q2Sz9S-jn0"),{data:a,error:i}=await n.from("bookings").select("\n        status,\n        packages (\n          destination\n        )\n      ");if(i)throw e({statusCode:500,statusMessage:"Failed to fetch booking data"});const r=[{type:"رحلات داخلية",count:0,percentage:0,color:"#10B981"},{type:"رحلات خارجية",count:0,percentage:0,color:"#F59E0B"},{type:"عمرة",count:0,percentage:0,color:"#EF4444"},{type:"رحلات ترفيهية",count:0,percentage:0,color:"#8B5CF6"}];null==a||a.forEach((t=>{var e,o;const s=(null==(o=null==(e=t.packages)?void 0:e.destination)?void 0:o.toLowerCase())||"";s.includes("مكة")||s.includes("المدينة")||s.includes("عمرة")?r[2].count++:s.includes("دبي")||s.includes("تركيا")||s.includes("مصر")?r[1].count++:s.includes("الرياض")||s.includes("جدة")||s.includes("الدمام")?r[0].count++:r[3].count++}));const c=r.reduce(((t,e)=>t+e.count),0);r.forEach((t=>{t.percentage=c>0?Math.round(t.count/c*100):0}));const u=[],d=["يناير","فبراير","مارس","أبريل","مايو","يونيو"];for(let t=5;t>=0;t--){const e=new Date;e.setMonth(e.getMonth()-t);const o=new Date(e.getFullYear(),e.getMonth(),1),s=new Date(e.getFullYear(),e.getMonth()+1,0),{data:a,error:i}=await n.from("bookings").select("total_price").gte("created_at",o.toISOString()).lte("created_at",s.toISOString()).eq("status","confirmed");if(!i&&a){const e=a.reduce(((t,e)=>t+e.total_price),0);u.push({month:d[5-t],amount:e,bookings:a.length})}else u.push({month:d[5-t],amount:0,bookings:0})}return{bookingDistribution:r,monthlySales:u}}catch(t){if(console.error("Dashboard charts error:",t),t.statusCode)throw t;throw e({statusCode:500,statusMessage:"Internal server error"})}}));export{n as default};
//# sourceMappingURL=charts.get.mjs.map
