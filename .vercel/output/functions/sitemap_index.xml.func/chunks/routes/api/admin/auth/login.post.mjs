import{d as s,r as e,c as o,g as r}from"../../../../_/nitro.mjs";import t from"bcryptjs";import i from"jsonwebtoken";import{createClient as a}from"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"vue";import"@iconify/utils";import"node:crypto";import"consola";import"node:module";import"node:url";import"ipx";import"node:fs";import"node:path";const n=s((async s=>{try{const n=await e(s),{email:d,password:c}=n;if(!d||!c)throw o({statusCode:400,statusMessage:"Email and password are required"});const m=a("https://ueofktshvaqtxjsxvisv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlb2ZrdHNodmFxdHhqc3h2aXN2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTkyMzE3NiwiZXhwIjoyMDc1NDk5MTc2fQ.8x1bRWz6UgyRgkMQf5c32qABhgRNnY-p8Q2Sz9S-jn0");console.log("Searching for admin user with email:",d.toLowerCase());const{data:p,error:u}=await m.from("admin_users").select("*").eq("email",d.toLowerCase()).eq("is_active",!0).single();if(console.log("Admin user query result:",{adminUser:p,userError:u}),u||!p)throw console.log("No admin user found or error:",u),o({statusCode:401,statusMessage:"Invalid credentials"});if(!await t.compare(c,p.password_hash))throw o({statusCode:401,statusMessage:"Invalid credentials"});const l=i.sign({id:p.id,role:p.role},process.env.JWT_SECRET||"your-secret-key",{expiresIn:"24h"}),h=new Date;h.setHours(h.getHours()+24);const{error:w}=await m.from("admin_sessions").insert({admin_user_id:p.id,session_token:l,expires_at:h.toISOString()});w&&console.error("Session creation error:",w),await m.from("admin_users").update({last_login:(new Date).toISOString()}).eq("id",p.id),await m.from("admin_activity_logs").insert({admin_user_id:p.id,action:"login",ip_address:"127.0.0.1",user_agent:r(s,"user-agent")||"Unknown"});const{password_hash:g,...f}=p;return{success:!0,user:f,sessionToken:l}}catch(s){if(console.error("Login error:",s),console.error("Error details:",s.message),console.error("Error stack:",s.stack),s.statusCode)throw s;throw o({statusCode:500,statusMessage:"Internal server error"})}}));export{n as default};
//# sourceMappingURL=login.post.mjs.map
